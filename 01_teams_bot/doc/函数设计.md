## Teams AI 机器人 Python 代码模块设计

本设计文档详细说明了构建 Microsoft Teams AI 机器人的 Python 代码结构，包括所需的模块、每个模块中的关键函数及其核心功能。

### 1. 项目结构概览

```
/your_teams_bot_project/
├── .env                     # 环境变量文件
├── app.py                   # Flask 应用主文件，集成 Bot Framework Adapter
├── bot/
│   ├── __init__.py
│   └── ai_bot.py            # 机器人类定义，处理消息和调用 AI 服务
├── requirements.txt         # 项目依赖列表
├── manifest.json            # Teams 应用清单文件
└── ... (其他可能的模块，如配置、工具等)
```

### 2. 核心模块设计

#### 2.1. `app.py` (Flask 应用主文件)

*   **功能：**
    *   初始化 Flask 应用。
    *   加载环境变量。
    *   配置 Bot Framework Adapter (推荐使用 `FlaskAdapter`)。
    *   实例化机器人类 (`ai_bot.py` 中的 `MyBot`)。
    *   定义 Flask 路由，处理来自 Teams 的消息 (`/api/messages`)。
    *   启动 Flask 开发服务器（用于本地测试）或配置与 WSGI 服务器（如 Gunicorn）的集成。

*   **关键函数/类：**
    *   `Flask(__name__)`: Flask 应用实例。
    *   `load_dotenv()`: 加载 `.env` 文件。
    *   `os.environ.get()`: 获取环境变量（`MicrosoftAppId`, `MicrosoftAppPassword`, `GEMINI_API_KEY`）。
    *   `FlaskAdapter(bot, APP_ID, APP_PASSWORD)`: (推荐) Bot Framework 的 Flask 适配器，用于处理请求和响应。
    *   `@app.route("/api/messages", methods=["POST"])`: 定义消息处理的路由。
    *   `messages()`: 处理 POST 请求的异步函数，调用适配器处理消息。
    *   `app.run()`: (开发时) 启动 Flask 内置服务器。
    *   (部署时) Gunicorn 会直接加载 `app` 实例。
    *   **依赖库：** `Flask`, `botbuilder-core`, `botbuilder-integration-flask`, `python-dotenv`, `os` (Python 标准库)

#### 2.2. `bot/ai_bot.py` (机器人核心逻辑)

*   **功能：**
    *   实现机器人的核心对话逻辑。
    *   继承 `ActivityHandler` 或使用 `FlaskAdapter` 集成。
    *   处理接收到的消息。
    *   调用 AI 服务（Gemini API）获取回复。
    *   将 AI 回复发送回 Teams。

*   **关键类与函数：**
    *   `class MyBot(ActivityHandler)`: 机器人的主类。
        *   `__init__(self, conversation_state: ConversationState, user_state: UserState)`: (可选) 初始化对话状态和用户状态管理器。
        *   `async def on_message_activity(self, turn_context: TurnContext)`:
            *   **功能：** 当收到用户消息活动时被调用。
            *   **实现：**
                1.  获取用户消息文本：`user_message = turn_context.activity.text`。
                2.  调用 `get_ai_response(user_message)` 获取 AI 回复。
                3.  发送 AI 回复：`await turn_context.send_activity(f"AI 回复: {ai_response}")`。
        *   `async def get_ai_response(self, message: str) -> str`:
            *   **功能：** 调用 AI 服务（Gemini API）并返回结果。
            *   **实现：**
                1.  配置 Gemini API (如果未在 `app.py` 中全局配置)。
                2.  初始化 Gemini 模型和对话。
                3.  使用 `chat.send_message(message)` 发送消息。
                4.  处理 API 响应，提取文本。
                5.  包含错误处理 (`try-except`)。
                6.  返回 AI 生成的文本或错误信息。
        *   `async def on_members_added_activity(self, members_added: ChannelAccount, turn_context: TurnContext)`: (可选) 当新成员加入对话时触发，可以发送欢迎消息。
        *   `async def on_message_reaction_activity(self, turn_context: TurnContext)`: (可选) 处理消息的反应。
    *   **依赖库：** `botbuilder-core`, `botbuilder-schema`, `google-generativeai`, `os` (Python 标准库)

### 3. 依赖管理

*   **`requirements.txt` 文件：**
    *   `botbuilder-core`
    *   `botbuilder-schema`
    *   `botbuilder-integration-flask` (用于 Flask 集成)
    *   `python-dotenv` (用于加载 `.env` 文件)
    *   `google-generativeai` (用于 Gemini API)
    *   `Flask` (Flask Web 框架)
    *   `gunicorn` (生产环境 WSGI 服务器)

### 4. 环境变量 (`.env` 文件)

*   `MicrosoftAppId`: 您的 Microsoft Entra ID 应用 ID。
*   `MicrosoftAppPassword`: 您的 Microsoft Entra ID 应用密码。
*   `GEMINI_API_KEY`: 您的 Google Gemini API 密钥。
