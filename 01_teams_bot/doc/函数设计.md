## Teams AI 机器人 Python 代码模块设计

本设计文档详细说明了构建 Microsoft Teams AI 机器人的 Python 代码结构，包括所需的模块、每个模块中的关键函数及其核心功能。

### 1. 项目结构概览

```
/your_teams_bot_project/
├── .env                     # 环境变量文件
├── app.py                   # Flask 应用主文件，集成 Bot Framework Adapter
├── bot/
│   ├── __init__.py
│   └── ai_bot.py            # 机器人类定义，处理消息并调用 AI 服务模块
│   └── ai_service.py        # AI 服务调用模块
├── requirements.txt         # 项目依赖列表
├── manifest.json            # Teams 应用清单文件
└── ... (其他可能的模块，如配置、工具等)
```

### 2. 核心模块设计

#### 2.1. `app.py` (Flask 应用主文件)

*   **功能：**
    *   初始化 Flask 应用。
    *   加载环境变量 (`.env` 文件)。
    *   配置 Bot Framework Adapter Settings (`MicrosoftAppId`, `MicrosoftAppPassword`)。
    *   实例化机器人类 (`MyBot`)。
    *   定义 Flask 路由 (`/api/messages`) 来处理来自 Teams 的消息。
    *   使用 `asyncio.run` 来处理异步消息处理。
    *   启动 Flask 开发服务器（默认端口 3978）。

*   **关键函数/类：**
    *   `Flask(__name__)`: Flask 应用实例。
    *   `load_dotenv()`: 加载 `.env` 文件中的环境变量。
    *   `os.environ.get()`: 获取 `MicrosoftAppId`, `MicrosoftAppPassword`。
    *   `ConversationState(None)`: 初始化对话状态管理器（当前为占位符）。
    *   `UserState(None)`: 初始化用户状态管理器（当前为占位符）。
    *   `MyBot(...)`: 实例化机器人类。
    *   `BotFrameworkAdapterSettings(APP_ID, APP_PASSWORD)`: 配置 Bot Framework Adapter 的设置。
    *   `BotFrameworkAdapter(settings)`: 创建 Bot Framework Adapter 实例。
    *   `@app.route("/api/messages", methods=["POST"])`: 定义消息处理的 POST 路由。
    *   `messages_endpoint()`: 处理入站消息的函数，调用 `bot_adapter.process`。
    *   `app.run(host="0.0.0.0", port=3978)`: 启动 Flask 开发服务器。
    *   **依赖库：** `Flask`, `botbuilder-core`, `python-dotenv`, `os` (Python 标准库), `asyncio`

#### 2.2. `bot/ai_bot.py` (机器人核心逻辑)

*   **功能：**
    *   实现机器人的核心对话逻辑，继承自 `TeamsActivityHandler`。
    *   处理用户消息，调用 AI 服务获取回复，并将回复发送回 Teams。
    *   处理新成员加入时的欢迎消息。

*   **关键类与函数：**
    *   `class MyBot(TeamsActivityHandler)`: 机器人的主类。
        *   `__init__(self, conversation_state: ConversationState, user_state: UserState)`: 初始化对话和用户状态管理器。
        *   `async def on_message_activity(self, turn_context: TurnContext)`:
            *   **功能：** 处理用户发送的消息。
            *   **实现：**
                1.  获取用户消息文本：`user_message = turn_context.activity.text`。
                2.  **调用 AI 服务获取回复：`ai_response = await ai_service.get_ai_response(user_message)`**。
                3.  发送 AI 回复：`await turn_context.send_activity(f"AI 回复: {ai_response}")`。
        *   `async def on_members_added_activity(self, members_added: ChannelAccount, turn_context: TurnContext)`:
            *   **功能：** 当新成员加入对话时触发。
            *   **实现：** 发送欢迎消息：“欢迎！我是您的 AI 助手。”
    *   **AI 服务集成：**
        *   导入 AI 服务：`from .ai_service import GeminiAIService` (相对导入)。
        *   初始化 AI 服务：`ai_service = GeminiAIService(...)`，需要 `GEMINI_API_KEY`。
        *   **AI 密钥检查：** 如果 `GEMINI_API_KEY` 未设置，则抛出 `ValueError`。
    *   **依赖库：** `botbuilder-core`, `botbuilder-schema`, `os` (Python 标准库)

#### 2.3. `bot/ai_service.py` (AI 服务调用模块)

*   **功能：**
    *   封装调用 Gemini API 的逻辑。
    *   提供 `get_ai_response` 方法来获取 AI 的回复。

*   **关键类与函数：**
    *   `class GeminiAIService`:
        *   `__init__(self, config: dict)`:
            *   **功能：** 初始化服务，配置 Gemini API。
            *   **实现：**
                1.  获取并验证 `api_key`。
                2.  调用 `genai.configure(api_key=self.api_key)`。
                3.  初始化生成模型：`self.model = genai.GenerativeModel('gemini-pro')`。
                4.  启动聊天会话：`self.chat = self.model.start_chat(history=[])`。
        *   `async def get_ai_response(self, message: str) -> str`:
            *   **功能：** 向 Gemini API 发送消息并返回回复。
            *   **实现：**
                1.  使用 `self.chat.send_message(message)` 发送消息。
                2.  获取响应文本并去除首尾空格：`response.text.strip()`。
                3.  **错误处理：** 使用 `try-except` 捕获异常，打印错误信息，并返回用户友好的错误消息：“抱歉，我无法处理您的请求。”
    *   **依赖库：** `google-generativeai`, `os` (Python 标准库)

### 3. 依赖管理

*   **`requirements.txt` 文件应包含：**
    *   `botbuilder-core`
    *   `botbuilder-schema`
    *   `botbuilder-integration-flask`
    *   `python-dotenv`
    *   `google-generativeai`
    *   `Flask`
    *   `gunicorn` (生产环境部署时)

### 4. 环境变量 (`.env` 文件)

*   `MicrosoftAppId`: Microsoft Entra ID 应用 ID。
*   `MicrosoftAppPassword`: Microsoft Entra ID 应用密码。
*   `GEMINI_API_KEY`: Google Gemini API 密钥。
