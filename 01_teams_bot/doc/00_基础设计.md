# 在 Microsoft Teams 中添加 AI 机器人的实施方案（Python 开发，非 Azure 平台部署集成 AI 服务）

本方案将指导您如何使用 Python 和 Microsoft Bot Framework SDK 开发一个 AI 机器人，并将其部署在您自己的服务器上，同时集成 AI 服务。

## 一、 先决条件：

*   **Microsoft 365 账户：** 拥有可以访问 Microsoft Teams 的账户。
*   **开发环境：**
    *   **Python:** 版本 3.8 或更高。
    *   **pip:** Python 的包管理器。
    *   **Visual Studio Code:** 安装 Python 扩展和 Teams Toolkit 扩展。
    *   **Ngrok:** 用于本地测试和隧道连接。
    *   **Bot Framework Emulator:** 用于本地测试和调试。
    *   **AI 服务访问凭证：** 例如 Google Gemini API 密钥，或您选择的其他 AI 服务的 API 密钥和端点。

## 二、 实施步骤：

### 1. Microsoft Entra ID 应用注册：

*   **操作：** 在 Microsoft Entra ID 门户中注册一个新的应用程序。
*   **获取信息：** 记录下应用程序（客户端）ID (Client ID) 和目录（租户）ID (Tenant ID)。
*   **创建凭证：** 创建一个客户端密码 (Client Secret)，并妥善保管。

### 2. 开发 Python 机器人服务：

*   **项目设置：**
    *   创建一个新的 Python 项目目录。
    *   创建一个虚拟环境（推荐）：`python -m venv venv`，然后激活它 (`source venv/bin/activate` 或 `venv\Scripts\activate`)。
    *   创建一个 `requirements.txt` 文件，并添加必要的库：
        ```txt
        botbuilder-core
        botbuilder-schema
        botbuilder-integration-flask # 使用 Flask 集成
        python-dotenv # 用于管理环境变量
        google-generativeai # 集成 Gemini API
        Flask # Flask Web 框架
        ```
    *   安装依赖：`pip install -r requirements.txt`

*   **机器人核心逻辑 (`app.py` 或类似文件)：**
    *   使用 `botbuilder-core` 和 `botbuilder-integration-flask` 库创建机器人应用。
    *   配置机器人的消息处理逻辑。当收到 Teams 消息时，机器人将调用 AI 服务模块。
    *   **示例（伪代码，以调用 Gemini 为例）：**
        ```python
        import os
        from dotenv import load_dotenv
        from botbuilder.core import ConversationState, UserState, TurnContext
        from botbuilder.core.teams import TeamsActivityHandler
        from botbuilder.schema import ChannelAccount
        from botbuilder.integration.flask import FlaskAdapter
        from flask import Flask, request

        # 导入 AI 服务模块
        from bot.ai_service import GeminiAIService # 假设 AI 服务实现已移至 bot/ai_service.py

        load_dotenv() # 加载 .env 文件中的环境变量

        APP_ID = os.environ.get("MicrosoftAppId")
        APP_PASSWORD = os.environ.get("MicrosoftAppPassword")

        # 初始化 AI 服务
        ai_service = GeminiAIService({
            "api_key": os.environ.get("GEMINI_API_KEY")
            # 可以添加其他配置，如模型名称
        })

        class MyBot(TeamsActivityHandler):
            def __init__(self, conversation_state: ConversationState, user_state: UserState):
                super().__init__()
                self.conversation_state = conversation_state
                self.user_state = user_state

            async def on_message_activity(self, turn_context: TurnContext):
                user_message = turn_context.activity.text
                # 调用 AI 服务获取回复
                ai_response = await ai_service.get_ai_response(user_message)

                await turn_context.send_activity(f"AI 回复: {ai_response}")

            async def on_members_added_activity(self, members_added: ChannelAccount, turn_context: TurnContext):
                for member in members_added:
                    if member.id != turn_context.activity.recipient.id:
                        await turn_context.send_activity("欢迎！我是您的 AI 助手。")

        # Flask 应用设置
        app = Flask(__name__)

        # 初始化状态管理器
        conversation_state = ConversationState(None)
        user_state = UserState(None)

        # 创建机器人实例
        bot = MyBot(conversation_state, user_state)

        # 配置 Bot Framework Flask Adapter
        bot_adapter = FlaskAdapter(bot, APP_ID, APP_PASSWORD)

        # 定义消息处理路由
        @app.route("/api/messages", methods=["POST"])
        async def messages_endpoint():
            return await bot_adapter.process(request, bot.on_turn)

        if __name__ == "__main__":
            # 运行 Flask 开发服务器
            # 在生产环境中，应使用 Gunicorn 或 uWSGI
            app.run(host="0.0.0.0", port=3978) # 端口可自定义
        ```

*   **AI 服务模块 (`bot/ai_service.py`)：**
    *   创建一个 `bot/ai_service.py` 文件，包含 AI 服务的具体实现。
    *   **示例 `bot/ai_service.py`：**
        ```python
        import os
        import google.generativeai as genai
        from botbuilder.core import TurnContext

        class GeminiAIService:
            def __init__(self, config: dict):
                self.api_key = config.get("api_key")
                if not self.api_key:
                    raise ValueError("Gemini API key is missing.")
                genai.configure(api_key=self.api_key)
                self.model = genai.GenerativeModel('gemini-pro') # 或其他可用模型
                self.chat = self.model.start_chat(history=[])

            async def get_ai_response(self, message: str) -> str:
                try:
                    response = self.chat.send_message(message)
                    return response.text.strip()
                except Exception as e:
                    print(f"Error calling Gemini API: {e}")
                    return "抱歉，我无法处理您的请求。"
        ```

*   **环境变量配置：**
    *   创建一个 `.env` 文件，包含您的 Microsoft Entra ID 应用凭证和 AI 服务密钥：
        ```dotenv
        MicrosoftAppId=YOUR_MICROSOFT_APP_ID
        MicrosoftAppPassword=YOUR_MICROSOFT_APP_PASSWORD
        GEMINI_API_KEY=YOUR_GEMINI_API_KEY
        ```

### 3. 创建 Teams 应用清单 (`manifest.json`)：

*   **文件结构：** 在项目根目录下创建 `manifest.json` 文件。
*   **内容示例：**
    ```json
    {
      "$schema": "https://developer.microsoft.com/json-schemas/teams/v1.16/MicrosoftTeams.schema.json",
      "version": "1.0.0",
      "id": "YOUR_MICROSOFT_APP_ID", // 必须与 Entra ID 应用 ID 相同
      "name": {
        "short": "My Python AI Bot",
        "full": "My Python AI Bot for Teams"
      },
      "description": {
        "short": "A Python AI bot for Teams",
        "full": "This bot uses Python and AI services to interact with users in Microsoft Teams."
      },
      "icons": {
        "color": "path/to/color.png", // 提供彩色图标路径
        "outline": "path/to/outline.png" // 提供轮廓图标路径
      },
      "accentColor": "#FFFFFF",
      "developer": {
        "name": "Your Name or Company",
        "websiteUrl": "https://your-website.com",
        "privacyUrl": "https://your-website.com/privacy",
        "termsOfUseUrl": "https://your-website.com/terms"
      },
      "bots": [
        {
          "botId": "YOUR_MICROSOFT_APP_ID", // 必须与 Entra ID 应用 ID 相同
          "scopes": [
            "personal",
            "team",
            "groupchat"
          ],
          "supportsFiles": false,
          "isNotificationOnly": false
        }
      ],
      "webApplicationInfo": {
        "id": "YOUR_MICROSOFT_APP_ID", // 必须与 Entra ID 应用 ID 相同
        "resource": "https://api.botframework.com"
      },
      "validDomains": [
        "your-ngrok-url.com", // 本地测试时使用 Ngrok 的域名
        "your-server-domain.com" // 部署后的服务器域名
      ]
    }
    ```
*   **图标：** 创建 `color.png` 和 `outline.png` 文件，并更新 `manifest.json` 中的路径。

### 4. 本地测试与调试：

*   **运行机器人：** 在激活的虚拟环境中运行您的机器人应用：`python app.py`。
*   **启动 Ngrok：** 在另一个终端窗口中，运行 Ngrok 来暴露您的机器人端口（例如，如果机器人运行在 3978 端口）：`ngrok http 3978`。
*   **获取 Ngrok URL：** Ngrok 会提供一个 `https://....ngrok.io` 的 URL。
*   **更新 Manifest：** 将 `manifest.json` 中的 `validDomains` 和 `messageEndpoint` 更新为 Ngrok 提供的 URL。
*   **使用 Bot Framework Emulator：**
    *   打开 Bot Framework Emulator。
    *   在“Open Bot”配置中，填入：
        *   Bot URL: `https://your-ngrok-url.com/api/messages`
        *   Microsoft App ID: `YOUR_MICROSOFT_APP_ID`
        *   Microsoft App Password: `YOUR_MICROSOFT_APP_PASSWORD`
    *   连接并测试机器人。

### 5. 部署机器人服务：

*   **选择服务器：** 准备一个可以运行 Python 应用的服务器（如 Ubuntu 服务器、VPS 等）。
*   **部署代码：** 将您的项目文件（包括 `app.py`, `requirements.txt`, `.env` 等）上传到服务器。
*   **安装依赖：** 在服务器上，进入项目目录，创建并激活虚拟环境，然后运行 `pip install -r requirements.txt`。
*   **配置环境变量：** 在服务器上设置环境变量，或者创建一个 `.env` 文件并确保您的应用能读取到它。
*   **配置 Web 服务器：**
    *   您可以使用 Gunicorn 或 uWSGI 等 WSGI 服务器来运行您的 Python Web 应用。
    *   例如，使用 Gunicorn：`gunicorn --bind 0.0.0.0:8000 --workers 4 app:app` (假设您的应用实例名为 `app`，端口为 8000)。
*   **配置反向代理 (Nginx/Apache)：**
    *   为了处理 HTTPS 和更健壮的部署，建议使用 Nginx 或 Apache 作为反向代理。
    *   配置 Nginx 将来自公共域名的 HTTPS 请求转发到您的 Gunicorn/uWSGI 运行的本地端口。
    *   **重要：** 确保您的服务器配置了有效的 SSL 证书，以启用 HTTPS。您可以使用 Let's Encrypt 获取免费证书。
*   **更新 Manifest：** 将 `manifest.json` 中的 `validDomains` 和 `messageEndpoint` 更新为您的服务器的公共域名和部署后的机器人路径（例如 `https://your-server-domain.com/api/messages`）。

### 6. 在 Teams 中安装机器人：

*   **打包应用：** 将更新后的 `manifest.json` 和图标文件打包成 `.zip` 文件。
*   **上传应用：** 在 Teams 客户端中，进入“应用” > “管理你的应用” > “上传自定义应用”，选择您的 `.zip` 文件。
*   **安装：** 将机器人安装到个人聊天、团队或群组中。

### 7. 集成 AI 服务（已在步骤 2 中体现）：

*   确保您的 Python 代码能够正确调用您选择的 AI 服务 API（如 Gemini）。
*   在代码中处理 API 响应，并将其作为机器人的回复发送给用户。

## 四、 注意事项：

*   **安全性：** 严格保护您的 `MicrosoftAppId`, `MicrosoftAppPassword` 和 AI 服务 API 密钥。使用环境变量或密钥管理服务，避免硬编码。
*   **HTTPS：** Teams 要求所有机器人通信都通过 HTTPS 进行。务必在服务器上配置好 SSL 证书。
*   **端口和域名：** 确保您的机器人服务监听的端口在服务器上是可访问的，并且您的域名解析正确，Nginx/Apache 配置也正确指向您的机器人应用。
*   **错误处理：** 在机器人代码中加入健壮的错误处理机制，特别是对于外部 AI 服务的调用。

--- 

**总结更改：**

*   **依赖：** 添加 `botbuilder-integration-flask`。
*   **代码结构：** 使用 Flask 的路由 (`@app.route`) 来处理 `/api/messages` 端点。
*   **适配器：** 强烈建议使用 `botbuilder-integration-flask` 提供的 `FlaskAdapter` 来简化集成，而不是直接使用 `BotFrameworkAdapter`。
*   **运行命令：** 部署时使用 Gunicorn 运行 Flask 应用。

这份文档详细说明了每个功能点的实现方法和所需的技术细节。在实际开发中，请根据您的具体需求和选择的框架进行调整。